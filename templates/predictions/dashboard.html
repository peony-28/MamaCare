{% extends 'base.html' %}

{% block title %}Dashboard - MamaCare{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-chart-line"></i> Dashboard
    {% if is_staff %}
    <small class="text-muted">(Admin View)</small>
    {% endif %}
</h2>

{% if is_staff %}
<!-- Admin Dashboard -->
<!-- Date Range Filter -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Filter by Date Range</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-12 col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter"></i> Apply Filter
                </button>
            </div>
        </form>
        {% if start_date and end_date %}
        <div class="mt-3 d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> Showing data from <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>
            </small>
            <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> Clear Filter
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if stats %}
<!-- Enhanced Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                <h5 class="card-title">Total Predictions</h5>
                <h2 class="text-primary">{{ stats.total_predictions|default:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <h5 class="card-title">High Risk Cases</h5>
                <h2 class="text-danger">{{ stats.high_risk_count|default:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="fas fa-users fa-2x text-success mb-2"></i>
                <h5 class="card-title">Unique Patients</h5>
                <h2 class="text-success">{{ stats.unique_patients|default:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="fas fa-user-md fa-2x text-info mb-2"></i>
                <h5 class="card-title">Health Workers</h5>
                <h2 class="text-info">{{ stats.unique_health_workers|default:0 }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <i class="fas fa-exclamation-circle fa-2x text-warning mb-2"></i>
                <h5 class="card-title">Preeclampsia Cases</h5>
                <h2 class="text-warning">{{ stats.preeclampsia_count|default:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="fas fa-heartbeat fa-2x text-info mb-2"></i>
                <h5 class="card-title">GDM Cases</h5>
                <h2 class="text-info">{{ stats.gdm_count|default:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h5 class="card-title">Low Risk Cases</h5>
                <h2 class="text-success">{{ stats.low_risk_count|default:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="fas fa-calendar-week fa-2x text-primary mb-2"></i>
                <h5 class="card-title">Last 7 Days</h5>
                <h2 class="text-primary">{{ stats.recent_predictions|default:0 }}</h2>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Health Workers Activity Section -->
{% if health_workers %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users"></i> Top Health Workers (by Activity)</h5>
        <a href="{% url 'health_workers' %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-list"></i> View All
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Health Worker</th>
                        <th>Total Predictions</th>
                        <th>High Risk Cases</th>
                        <th>Last Activity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hw in health_workers %}
                    <tr>
                        <td>
                            {% if hw.user %}
                                <strong>{{ hw.user.get_full_name|default:hw.user.username }}</strong><br>
                                <small class="text-muted">{{ hw.user.email|default:"No email" }}</small>
                            {% else %}
                                <strong>User ID: {{ hw.user_id }}</strong><br>
                                <small class="text-muted">(User may have been deleted)</small>
                            {% endif %}
                        </td>
                        <td><strong>{{ hw.total_predictions }}</strong></td>
                        <td>
                            <span class="badge bg-danger">{{ hw.high_risk_count }}</span>
                        </td>
                        <td>
                            {% if hw.last_prediction %}
                                {{ hw.last_prediction|date:"M d, Y" }}
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if hw.user %}
                            <a href="{% url 'health_worker_detail' hw.user.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Predictions -->
<h4 class="mb-3"><i class="fas fa-clock"></i> Recent Predictions (All Users)</h4>
{% if all_predictions %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Patient ID</th>
                    <th>Patient Name</th>
                    <th>Health Worker</th>
                    <th>General Risk</th>
                    <th>Preeclampsia</th>
                    <th>GDM</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for pred in all_predictions %}
                <tr>
                    <td>{{ pred.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        {% if pred.patient_id %}
                            <strong><a href="{% url 'patient_detail' pred.patient_id %}">{{ pred.patient_id }}</a></strong>
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ pred.patient_name|default:"Unknown" }}</td>
                    <td>
                        <small>
                            {% if pred.user_id %}
                                User ID: {{ pred.user_id|truncatechars:15 }}
                            {% else %}
                                Unknown
                            {% endif %}
                        </small>
                    </td>
                    <td>
                        <span class="badge {% if pred.general_risk == 'High' %}bg-danger{% else %}bg-success{% endif %}">
                            {{ pred.general_risk|default:"Unknown" }}
                        </span>
                    </td>
                    <td><small>{{ pred.preeclampsia_risk|default:"-" }}</small></td>
                    <td><small>{{ pred.gdm_risk|default:"-" }}</small></td>
                    <td>
                        {% if pred.patient_id %}
                        <a href="{% url 'patient_detail' pred.patient_id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No predictions in the system yet.
    </div>
{% endif %}

<!-- Quick Actions for Admin -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-search fa-3x text-primary mb-3"></i>
                <h5>Patient Lookup</h5>
                <p class="text-muted small">Search any patient by ID</p>
                <a href="{% url 'history' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-search"></i> Search
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-3x text-success mb-3"></i>
                <h5>Health Workers</h5>
                <p class="text-muted small">Manage health workers</p>
                <a href="{% url 'health_workers' %}" class="btn btn-success btn-sm">
                    <i class="fas fa-users"></i> Manage
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-chart-bar fa-3x text-warning mb-3"></i>
                <h5>Analytics</h5>
                <p class="text-muted small">View charts & reports</p>
                <a href="{% url 'analytics' %}" class="btn btn-warning btn-sm">
                    <i class="fas fa-chart-bar"></i> View
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-download fa-3x text-info mb-3"></i>
                <h5>Export Data</h5>
                <p class="text-muted small">Download CSV reports</p>
                <a href="{% url 'export_csv' %}{% if start_date and end_date %}?start_date={{ start_date }}&end_date={{ end_date }}{% endif %}" class="btn btn-info btn-sm">
                    <i class="fas fa-download"></i> Export
                </a>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Health Worker Dashboard -->
<h4 class="mb-3">Your Recent Predictions</h4>
{% if user_predictions %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Patient ID</th>
                    <th>Patient Name</th>
                    <th>General Risk</th>
                    <th>Preeclampsia</th>
                    <th>GDM</th>
                    <th>Overall Assessment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for pred in user_predictions %}
                <tr>
                    <td>{{ pred.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        {% if pred.patient_id %}
                            <strong><a href="{% url 'patient_detail' pred.patient_id %}">{{ pred.patient_id }}</a></strong>
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ pred.patient_name|default:"Unknown" }}</td>
                    <td>
                        <span class="badge {% if pred.general_risk == 'High' %}bg-danger{% else %}bg-success{% endif %}">
                            {{ pred.general_risk|default:"Unknown" }}
                        </span>
                    </td>
                    <td><small>{{ pred.preeclampsia_risk|default:"-" }}</small></td>
                    <td><small>{{ pred.gdm_risk|default:"-" }}</small></td>
                    <td><small>{{ pred.overall_assessment|default:"-" }}</small></td>
                    <td>
                        {% if pred.patient_id %}
                        <a href="{% url 'patient_detail' pred.patient_id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No predictions yet. <a href="{% url 'predict' %}">Make your first prediction</a>
    </div>
{% endif %}

<div class="row mt-4 g-3">
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-body text-center d-flex flex-column">
                <i class="fas fa-search fa-3x text-primary mb-3"></i>
                <h5>Patient Lookup</h5>
                <p class="text-muted flex-grow-1">Search for any patient by ID to view their history</p>
                <a href="{% url 'history' %}" class="btn btn-primary mt-auto">
                    <i class="fas fa-search"></i> Search Patients
                </a>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-body text-center d-flex flex-column">
                <i class="fas fa-stethoscope fa-3x text-success mb-3"></i>
                <h5>New Prediction</h5>
                <p class="text-muted flex-grow-1">Create a new risk prediction for a patient</p>
                <a href="{% url 'predict' %}" class="btn btn-success mt-auto">
                    <i class="fas fa-plus"></i> New Prediction
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4">
    <a href="{% url 'predict' %}" class="btn btn-primary">
        <i class="fas fa-stethoscope"></i> New Prediction
    </a>
    <a href="{% url 'history' %}" class="btn btn-secondary">
        <i class="fas fa-history"></i> View Full History
    </a>
</div>
{% endblock %}
