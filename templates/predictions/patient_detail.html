{% extends 'base.html' %}

{% block title %}Prediction Overview - {{ patient.patient_name }} - MamaCare{% endblock %}

{% block extra_css %}
{% load static %}
<link href="{% static 'css/main.css' %}" rel="stylesheet">
<style>
    .prediction-overview-header {
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 20px;
    }
    .info-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        transition: box-shadow 0.3s;
    }
    .info-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
    }
    .patient-header-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
    }
    .patient-header-card h4 {
        color: white;
        margin-bottom: 15px;
    }
    .patient-header-card .patient-id {
        background: rgba(255,255,255,0.2);
        padding: 8px 15px;
        border-radius: 20px;
        display: inline-block;
        font-weight: bold;
    }
    .condition-tag {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        margin: 5px 5px 5px 0;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .tag-preeclampsia {
        background-color: #ffe0e0;
        color: #8b0000;
        border: 1px solid #ffcccc;
    }
    .tag-gdm {
        background-color: #e0ffe0;
        color: #006400;
        border: 1px solid #ccffcc;
    }
    .tag-high-risk {
        background-color: #fff0e0;
        color: #8b4513;
        border: 1px solid #ffe0cc;
    }
    .probability-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid var(--primary-color);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .progress-bar-custom {
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        padding: 0 12px;
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .recommendations-list {
        list-style: none;
        padding-left: 0;
    }
    .recommendations-list li {
        padding: 10px 0;
        padding-left: 30px;
        position: relative;
        border-bottom: 1px solid #f0f0f0;
    }
    .recommendations-list li:last-child {
        border-bottom: none;
    }
    .recommendations-list li:before {
        content: "→";
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-size: 1.2rem;
        font-weight: bold;
    }
    .previous-visits {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 3px solid #e0e0e0;
    }
    .visit-comparison-card {
        border-left: 5px solid var(--primary-color);
        margin-bottom: 20px;
        transition: all 0.3s;
        border-radius: 8px;
    }
    .visit-comparison-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .visit-comparison-card.high-risk {
        border-left-color: var(--danger-color);
    }
    .visit-comparison-card.low-risk {
        border-left-color: var(--success-color);
    }
    .metric-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
    }
    .metric-item {
        text-align: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    .metric-label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .metric-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    .risk-badge-large {
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.1rem;
        display: inline-block;
    }
    .section-title {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }
    .latest-visit-badge {
        background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
{% if comparison_data %}
{% with latest=comparison_data|first %}
<!-- Patient Header -->
<div class="patient-header-card">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h4 class="mb-2"><i class="fas fa-user"></i> {{ patient.patient_name }}</h4>
            <div class="patient-id">{{ patient_id }}</div>
            <div class="mt-3">
                <small style="opacity: 0.9;">
                    <i class="fas fa-calendar"></i> Latest Visit: {{ latest.date|date:"F d, Y" }} at {{ latest.date|date:"H:i" }} | 
                    <i class="fas fa-user-md"></i> Recorded by: {{ latest.health_worker }} | 
                    <i class="fas fa-hospital"></i> Total Visits: {{ total_visits }}
                </small>
            </div>
        </div>
        <div class="text-end">
            <span class="risk-badge-large {% if latest.risks.general_risk == 'High' %}bg-danger{% else %}bg-success{% endif %} text-white">
                {{ latest.risks.general_risk|default:"Unknown" }} Risk
            </span>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-end gap-2 mb-4">
    <a href="{% url 'history' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to History
    </a>
    <button class="btn btn-outline-primary" onclick="window.print()">
        <i class="fas fa-download"></i> Download Report
    </button>
    <a href="{% url 'predict' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> New Prediction
    </a>
</div>

<!-- Main Content - Two Column Layout -->
<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Risk Assessment Results -->
        <div class="card info-card">
            <div class="card-body">
                <h5 class="card-title mb-4 section-title">
                    <i class="fas fa-exclamation-triangle"></i> Risk Assessment Results
                </h5>
                
                <!-- Predicted Conditions -->
                <div class="mb-4">
                    <strong class="d-block mb-2">Predicted Conditions:</strong>
                    <div>
                        {% if 'Preeclampsia' in latest.risks.preeclampsia_risk or 'Present' in latest.risks.preeclampsia_risk %}
                        <span class="condition-tag tag-preeclampsia">
                            <i class="fas fa-exclamation-circle"></i> Preeclampsia
                        </span>
                        {% endif %}
                        {% if 'GDM' in latest.risks.gdm_risk or 'Gestational Diabetes' in latest.risks.gdm_risk %}
                        <span class="condition-tag tag-gdm">
                            <i class="fas fa-heartbeat"></i> Gestational Diabetes
                        </span>
                        {% endif %}
                        {% if latest.risks.general_risk == 'High' %}
                        <span class="condition-tag tag-high-risk">
                            <i class="fas fa-warning"></i> High Risk Pregnancy
                        </span>
                        {% endif %}
                        {% if not 'Preeclampsia' in latest.risks.preeclampsia_risk and not 'GDM' in latest.risks.gdm_risk and latest.risks.general_risk != 'High' %}
                        <span class="condition-tag" style="background-color: #e0ffe0; color: #006400; border: 1px solid #ccffcc;">
                            <i class="fas fa-check-circle"></i> Low Risk
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Model Confidence -->
                <div class="mt-4">
                    <strong class="d-block mb-3">Model Confidence:</strong>
                    <div class="progress" style="height: 40px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="progress-bar bg-primary d-flex align-items-center justify-content-center" 
                             role="progressbar" 
                             style="width: 85%; font-weight: 600; font-size: 0.95rem;">
                            <i class="fas fa-chart-line me-2"></i> 85% Confidence
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clinical Recommendations -->
        <div class="card info-card">
            <div class="card-body">
                <h5 class="card-title mb-4 section-title">
                    <i class="fas fa-clipboard-list"></i> Clinical Recommendations
                </h5>
                <ul class="recommendations-list">
                    {% if latest.risks.general_risk == 'High' %}
                    <li>Refer to a higher-level facility for continuous monitoring and specialist consultation.</li>
                    <li>Schedule bi-weekly monitoring of blood pressure and proteinuria.</li>
                    {% if 'Preeclampsia' in latest.risks.preeclampsia_risk or 'Present' in latest.risks.preeclampsia_risk %}
                    <li>Educate the patient on the warning signs of preeclampsia and instruct her to report them immediately.</li>
                    <li>Monitor blood pressure regularly and consider antihypertensive therapy if indicated.</li>
                    {% endif %}
                    {% if 'GDM' in latest.risks.gdm_risk or 'Gestational Diabetes' in latest.risks.gdm_risk %}
                    <li>Implement dietary modifications and glucose monitoring protocol.</li>
                    <li>Consider referral to endocrinologist for glycemic control management.</li>
                    {% endif %}
                    <li>Prepare for potential complications and ensure emergency protocols are in place.</li>
                    {% else %}
                    <li>Continue routine antenatal care with standard monitoring protocols.</li>
                    <li>Maintain regular follow-up visits as per standard schedule.</li>
                    <li>Educate patient on healthy pregnancy practices and warning signs to watch for.</li>
                    <li>Monitor key indicators at each visit to ensure continued low-risk status.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Patient Overview -->
        <div class="card info-card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-user-circle"></i> Patient Overview
                </h5>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Age</small>
                    <strong class="fs-5">{{ latest.vitals.age|default:"N/A" }} years</strong>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Blood Pressure</small>
                    <strong class="fs-5">{{ latest.vitals.systolic_bp|default:"-" }}/{{ latest.vitals.diastolic_bp|default:"-" }} mmHg</strong>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Parity</small>
                    <strong class="fs-5">{{ latest.pregnancy.parity|default:"N/A" }}</strong>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Gestational Age</small>
                    <strong class="fs-5">{{ latest.pregnancy.gestational_age|default:"N/A" }} weeks</strong>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">BMI</small>
                    <strong class="fs-5">{{ latest.vitals.bmi|default:"N/A" }} kg/m²</strong>
                </div>
                <div>
                    <small class="text-muted d-block mb-1">ANC Visits</small>
                    <strong class="fs-5">{{ total_visits }}</strong>
                </div>
            </div>
        </div>

        <!-- Condition Probability Breakdown -->
        <div class="card info-card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-chart-pie"></i> Condition Probabilities
                </h5>
                
                <!-- Preeclampsia Probability -->
                <div class="probability-box">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Preeclampsia</strong>
                        <strong>{% if 'Preeclampsia' in latest.risks.preeclampsia_risk or 'Present' in latest.risks.preeclampsia_risk %}65%{% else %}15%{% endif %}</strong>
                    </div>
                    <div class="progress" style="height: 22px; border-radius: 4px;">
                        <div class="progress-bar {% if 'Preeclampsia' in latest.risks.preeclampsia_risk or 'Present' in latest.risks.preeclampsia_risk %}bg-danger{% else %}bg-secondary{% endif %}" 
                             role="progressbar" 
                             style="width: {% if 'Preeclampsia' in latest.risks.preeclampsia_risk or 'Present' in latest.risks.preeclampsia_risk %}65%{% else %}15%{% endif %}">
                        </div>
                    </div>
                </div>

                <!-- GDM Probability -->
                <div class="probability-box">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Gestational Diabetes</strong>
                        <strong>{% if 'GDM' in latest.risks.gdm_risk or 'Gestational Diabetes' in latest.risks.gdm_risk %}45%{% else %}15%{% endif %}</strong>
                    </div>
                    <div class="progress" style="height: 22px; border-radius: 4px;">
                        <div class="progress-bar {% if 'GDM' in latest.risks.gdm_risk or 'Gestational Diabetes' in latest.risks.gdm_risk %}bg-warning{% else %}bg-secondary{% endif %}" 
                             role="progressbar" 
                             style="width: {% if 'GDM' in latest.risks.gdm_risk or 'Gestational Diabetes' in latest.risks.gdm_risk %}45%{% else %}15%{% endif %}">
                        </div>
                    </div>
                </div>

                <!-- High Risk Probability -->
                <div class="probability-box">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>High Risk Pregnancy</strong>
                        <strong>{% if latest.risks.general_risk == 'High' %}78%{% else %}22%{% endif %}</strong>
                    </div>
                    <div class="progress" style="height: 22px; border-radius: 4px;">
                        <div class="progress-bar {% if latest.risks.general_risk == 'High' %}bg-danger{% else %}bg-success{% endif %}" 
                             role="progressbar" 
                             style="width: {% if latest.risks.general_risk == 'High' %}78%{% else %}22%{% endif %}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Previous Visit Statistics -->
<div class="previous-visits">
    <h3 class="section-title mb-4">
        <i class="fas fa-history"></i> Previous Visit Statistics
    </h3>
    
    {% for data in comparison_data %}
    {% if not forloop.first %}
    <div class="card visit-comparison-card {% if data.risks.general_risk == 'High' %}high-risk{% else %}low-risk{% endif %}">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1">
                    <i class="fas fa-calendar-alt"></i> Visit #{{ forloop.revcounter }} - {{ data.date|date:"F d, Y" }} at {{ data.date|date:"H:i" }}
                </h5>
                <small class="text-muted">
                    <i class="fas fa-user-md"></i> Recorded by: <strong>{{ data.health_worker }}</strong>
                </small>
            </div>
            <span class="badge {% if data.risks.general_risk == 'High' %}bg-danger{% else %}bg-success{% endif %} fs-6 px-3 py-2">
                {{ data.risks.general_risk|default:"Unknown" }}
            </span>
        </div>
        <div class="card-body">
            <div class="metric-comparison mb-3">
                <div class="metric-item">
                    <div class="metric-label">Age</div>
                    <div class="metric-value">{{ data.vitals.age|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Gest. Age</div>
                    <div class="metric-value">{{ data.pregnancy.gestational_age|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Systolic BP</div>
                    <div class="metric-value">{{ data.vitals.systolic_bp|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Diastolic BP</div>
                    <div class="metric-value">{{ data.vitals.diastolic_bp|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Heart Rate</div>
                    <div class="metric-value">{{ data.vitals.heart_rate|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">BMI</div>
                    <div class="metric-value">{{ data.vitals.bmi|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Hemoglobin</div>
                    <div class="metric-value">{{ data.lab_values.hemoglobin|default:"-" }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Blood Sugar</div>
                    <div class="metric-value">{{ data.lab_values.blood_sugar|default:"-" }}</div>
                </div>
            </div>
            <div class="mb-3">
                <strong class="d-block mb-2">Risk Assessment:</strong>
                <div>
                    <span class="badge {% if data.risks.general_risk == 'High' %}bg-danger{% else %}bg-success{% endif %} me-2">
                        General: {{ data.risks.general_risk|default:"-" }}
                    </span>
                    <span class="badge bg-warning text-dark me-2">
                        Preeclampsia: {{ data.risks.preeclampsia_risk|default:"-" }}
                    </span>
                    <span class="badge bg-info me-2">
                        GDM: {{ data.risks.gdm_risk|default:"-" }}
                    </span>
                </div>
            </div>
            <div class="alert alert-{% if data.risks.general_risk == 'High' %}danger{% else %}info{% endif %} mb-0">
                <strong><i class="fas fa-clipboard-check"></i> Assessment:</strong> {{ data.risks.overall_assessment|default:"No assessment available" }}
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

{% endwith %}
{% else %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> No prediction data available for this patient.
</div>
{% endif %}

<div class="mt-5 text-center text-muted small">
    System Version 1.0.0 | Confidential Patient Information. For authorized use only.
</div>
{% endblock %}
